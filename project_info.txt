# Project Informatie: aiontwikkelhulp

## Projectoverzicht
De AI Ontwikkelhulp (aiontwikkelhulp) is een tool die de communicatie tussen gebruikers en AI-modellen (specifiek Claude) faciliteert om code-ontwikkeling en repository-beheer te ondersteunen. De tool biedt een gestructureerde manier om AI-gestuurde ontwikkeling uit te voeren volgens een vooraf gedefinieerde werkwijze. Ondersteunt nu configureerbare LLM instellingen inclusief temperature configuratie en presets voor verschillende use cases.

## Architectuur
De aiontwikkelhulp bestaat uit verschillende modules die samenwerken om gebruikers te helpen bij het ontwikkelen van software met behulp van AI:

### Core Modules:
- Flask web-applicatie (app.py)
- Anthropic API integratie (anthropic_api.py) - met LLM settings support
- MCP Connector voor tools integratie (mcp_connector.py)
- Configuratie (config.py)
- Repository beheer

### Nieuwe Modules (Refactoring):
- Anthropic configuratie (anthropic_config.py) - met LLM settings en presets
- Anthropic client (anthropic_client.py) - met temperature en preset ondersteuning
- Conversation manager (conversation_manager.py)
- MCP integratie (mcp_integration.py)

### Frontend Modules:
- templates/home.html - Hoofdtemplate met chat interface
- static/css/style.css - Styling voor de applicatie
- static/js/log-formatter.js - Log formatting functionaliteit
- static/css/log-formatter.css - Styling voor geformatteerde logs

## Modules

### anthropic_api.py
- **Status**: Uitgebreid met LLM settings management
- **Pad**: /anthropic_api.py
- **Functionaliteit**: High-level API voor interactie met Anthropic Claude modellen. Coördineert tussen client, conversation management, en MCP integratie. Ondersteunt conditionele inclusie van project_info in cache. Nieuw: LLM settings management, temperature configuratie, runtime settings updates, en preset ondersteuning.
- **Afhankelijkheden**: anthropic_config.py, anthropic_client.py, conversation_manager.py, mcp_integration.py, repositories

### anthropic_config.py
- **Status**: Uitgebreid met LLM settings en presets
- **Pad**: /anthropic_config.py
- **Functionaliteit**: Centralized Anthropic-specifieke configuratie met lazy loading en validatie. Ondersteunt nu ook lazy loading van project_info.txt. Nieuw: Temperature property (default 0.2), LLM presets (developer_agent, creative_writing, analysis, balanced), settings validatie, model-specifieke instellingen, en environment variable ondersteuning.
- **Afhankelijkheden**: Geen directe afhankelijkheden

### anthropic_client.py
- **Status**: Uitgebreid met LLM settings ondersteuning
- **Pad**: /anthropic_client.py
- **Functionaliteit**: Pure API communicatie met Claude modellen. Ondersteunt ephemeral caching van zowel system prompt als project_info. Nieuw: Temperature parameter ondersteuning, preset functionaliteit, parameter override capability, model-specifieke settings toepassing, en LLM settings validatie.
- **Afhankelijkheden**: anthropic_config.py

### conversation_manager.py
- **Status**: Volledig geïntegreerd met database
- **Pad**: /conversation_manager.py
- **Functionaliteit**: Beheert conversatie staat en geschiedenis met robuuste database persistentie. Ondersteunt pagination, search, metadata beheer, soft delete. Behoudt backwards compatibility met in-memory storage.
- **Afhankelijkheden**: repositories (ConversationRepository voor database operaties)

### mcp_integration.py
- **Status**: Nieuw toegevoegd
- **Pad**: /mcp_integration.py
- **Functionaliteit**: Beheert MCP server connecties en tool gebruik.
- **Afhankelijkheden**: mcp_connector.py, anthropic_config.py

### config.py
- **Status**: Gerefactored
- **Pad**: /config.py
- **Functionaliteit**: Verzorgt de algemene applicatie configuratie. Anthropic-specifieke config is verplaatst naar anthropic_config.py.
- **Afhankelijkheden**: anthropic_config.py

### mcp_connector.py
- **Status**: Actief
- **Pad**: /mcp_connector.py
- **Functionaliteit**: Zorgt voor communicatie met externe tools die AI kan gebruiken.
- **Afhankelijkheden**: Geen directe afhankelijkheden binnen het project

### app.py
- **Status**: Actief
- **Pad**: /app.py
- **Functionaliteit**: Flask web-applicatie die de gebruikersinterface biedt.
- **Afhankelijkheden**: anthropic_api.py, config.py

### routes/api.py
- **Status**: Uitgebreid met LLM settings API endpoints
- **Pad**: /routes/api.py
- **Functionaliteit**: API endpoints voor conversation management inclusief pagination, search, bulk operations, CRUD operaties met database persistence. Geïntegreerd met ConversationManager voor robuuste data handling. Bugfix toegepast voor thread context issue in send_prompt_stream functie. Nieuw: LLM settings API endpoints (GET/PUT /api/llm-settings, GET /api/llm-settings/defaults, GET /api/llm-settings/presets), temperature en preset ondersteuning in prompt endpoints.
- **Afhankelijkheden**: anthropic_api.py, ConversationManager, ConversationRepository, Flask app context

### templates/home.html
- **Status**: Actief (bijgewerkt met log formatter)
- **Pad**: /templates/home.html
- **Functionaliteit**: Hoofdtemplate voor de chat interface. Ondersteunt nu gesplitste weergave van chat en log berichten in aparte kolommen. Geïntegreerd met conversation persistence en enhanced log formatting.
- **Afhankelijkheden**: base.html, static/css/style.css, static/js/log-formatter.js, static/css/log-formatter.css

### templates/conversations.html
- **Status**: Actief (bijgewerkt voor persistence)
- **Pad**: /templates/conversations.html
- **Functionaliteit**: Template voor conversation management interface. Ondersteunt conversation listing, search, rename, delete operations met real-time updates.
- **Afhankelijkheden**: base.html, API endpoints

### static/css/style.css
- **Status**: Actief (bijgewerkt)
- **Pad**: /static/css/style.css
- **Functionaliteit**: Styling voor de applicatie inclusief GitHub-achtige thema's. Ondersteunt nu de gesplitste kolom layout voor chat en logs.
- **Afhankelijkheden**: Geen

### static/js/log-formatter.js
- **Status**: Nieuw toegevoegd
- **Pad**: /static/js/log-formatter.js
- **Functionaliteit**: JavaScript module voor het formatteren van log berichten. Detecteert log types (JSON, tool use, results, errors) en past passende formatting toe. Ondersteunt collapsible logs voor lange content.
- **Afhankelijkheden**: Geen

### static/css/log-formatter.css
- **Status**: Nieuw toegevoegd
- **Pad**: /static/css/log-formatter.css
- **Functionaliteit**: CSS styling voor geformatteerde log berichten. Bevat kleurcodering voor verschillende log types, JSON syntax highlighting, en responsive design.
- **Afhankelijkheden**: Gebruikt CSS variabelen uit style.css

### werkwijze/werkwijze.txt
- **Status**: Actief
- **Pad**: /werkwijze/werkwijze.txt
- **Functionaliteit**: Bevat instructies voor het AI-model over hoe repository-ontwikkeling moet verlopen.
- **Afhankelijkheden**: Wordt gebruikt door anthropic_config.py (lazy loaded)

### system_prompt.txt
- **Status**: Actief
- **Pad**: /system_prompt.txt
- **Functionaliteit**: Bevat de basis system prompt voor het AI-model.
- **Afhankelijkheden**: Wordt gebruikt door anthropic_config.py (lazy loaded)

### project_info.txt
- **Status**: Actief
- **Pad**: /project_info.txt
- **Functionaliteit**: Bevat projectinformatie die wordt gecached voor betere performance bij ontwikkel-gerelateerde vragen.
- **Afhankelijkheden**: Wordt gebruikt door anthropic_config.py (lazy loaded)

### repositories/conversation_repository.py
- **Status**: Actief (volledig geïntegreerd)
- **Pad**: /repositories/conversation_repository.py
- **Functionaliteit**: CRUD operaties voor conversations en messages met SQLAlchemy. Ondersteunt soft delete, bulk operations, en transaction management.
- **Afhankelijkheden**: models/conversation.py, database.py

### models/conversation.py
- **Status**: Actief (bijgewerkt)
- **Pad**: /models/conversation.py
- **Functionaliteit**: Database modellen voor conversations en messages. Ondersteunt metadata storage, timestamps, en relationships.
- **Afhankelijkheden**: database.py (SQLAlchemy)

### database.py
- **Status**: Actief
- **Pad**: /database.py
- **Functionaliteit**: Database configuratie en session management voor SQLAlchemy.
- **Afhankelijkheden**: Flask-SQLAlchemy

### tests/test_anthropic_config.py
- **Status**: Actief (bijgewerkt)
- **Pad**: /tests/test_anthropic_config.py
- **Functionaliteit**: Unit tests voor AnthropicConfig module, inclusief tests voor project_info caching.
- **Afhankelijkheden**: anthropic_config.py

### tests/test_anthropic_config_llm_settings.py
- **Status**: Nieuw toegevoegd
- **Pad**: /tests/test_anthropic_config_llm_settings.py
- **Functionaliteit**: Unit tests voor AnthropicConfig LLM settings functionaliteit, inclusief temperature validatie, presets, model-specifieke instellingen, en environment variable loading.
- **Afhankelijkheden**: anthropic_config.py

### tests/test_anthropic_client.py
- **Status**: Uitgebreid met LLM settings tests
- **Pad**: /tests/test_anthropic_client.py
- **Functionaliteit**: Unit tests voor AnthropicClient module, inclusief tests voor project_info caching. Nieuw: Tests voor temperature parameters, preset functionaliteit, parameter overrides, model-specifieke settings, en validatie.
- **Afhankelijkheden**: anthropic_client.py, anthropic_config.py

### tests/test_conversation_manager.py
- **Status**: Volledig uitgebreid
- **Pad**: /tests/test_conversation_manager.py
- **Functionaliteit**: Comprehensive unit tests voor ConversationManager inclusief database integration, CRUD operations, search, pagination, error handling.
- **Afhankelijkheden**: conversation_manager.py

### tests/test_api_conversation_persistence.py
- **Status**: Nieuw toegevoegd
- **Pad**: /tests/test_api_conversation_persistence.py
- **Functionaliteit**: API tests voor conversation persistence endpoints inclusief pagination, search, bulk operations, authentication, authorization.
- **Afhankelijkheden**: routes/api.py, ConversationManager, ConversationRepository

### tests/test_api_llm_settings.py
- **Status**: Nieuw toegevoegd
- **Pad**: /tests/test_api_llm_settings.py
- **Functionaliteit**: API tests voor LLM settings endpoints inclusief GET/PUT settings, presets, defaults, validation, en prompt endpoint integratie met LLM parameters.
- **Afhankelijkheden**: routes/api.py, anthropic_api

## Recente Wijzigingen

### Implementatie van LLM Settings (Issue #46)
- **Backend Configuratie**: 
  - AnthropicConfig uitgebreid met temperature property (default 0.2)
  - LLM presets toegevoegd (developer_agent, creative_writing, analysis, balanced)
  - Settings validatie (temperature 0.0-1.0, max_tokens > 0)
  - Environment variable ondersteuning (ANTHROPIC_TEMPERATURE, ANTHROPIC_MAX_TOKENS)
- **API Integratie**:
  - AnthropicClient ondersteunt temperature en preset parameters
  - Parameter override functionaliteit voor runtime aanpassingen
  - Model-specifieke settings toepassing met token limits
  - Ephemeral caching voor project info en system prompts
- **API Endpoints**:
  - GET /api/llm-settings - Ophalen huidige instellingen
  - PUT /api/llm-settings - Runtime settings update
  - GET /api/llm-settings/defaults - Standaard instellingen
  - GET /api/llm-settings/presets - Beschikbare presets
  - Prompt endpoints uitgebreid met temperature/preset parameters
- **Validatie & Error Handling**:
  - Client-side en server-side validatie van temperature (0.0-1.0)
  - Max tokens validatie met model limits
  - Comprehensive error handling en logging
- **Testing**:
  - Unit tests voor AnthropicConfig LLM settings
  - Uitgebreide AnthropicClient tests met LLM parameters
  - API tests voor alle nieuwe endpoints en validatie
- **Presets Configuratie**:
  - Developer Agent: temperature 0.2, optimaal voor code generatie
  - Creative Writing: temperature 0.8, hogere creativiteit
  - Analysis: temperature 0.1, deterministische analyse
  - Balanced: temperature 0.5, algemeen gebruik

### Implementatie van Log Formatting (Issue #41)
- **UI Verbetering**: Log berichten worden nu automatisch geformatteerd voor betere leesbaarheid
- **Log Type Detectie**: Automatische detectie van verschillende log types:
  - JSON data met syntax highlighting
  - Tool gebruik met duidelijke headers
  - Result berichten met gestructureerde weergave
  - Error berichten met rode accenten
- **Collapsible Logs**: Lange log berichten kunnen in- en uitgeklapt worden
- **Kleurcodering**: Verschillende kleuren voor verschillende onderdelen van logs
- **Dark Mode Support**: Volledig geïntegreerd met het bestaande thema systeem
- **Bestanden toegevoegd**:
  - static/js/log-formatter.js - JavaScript module voor log formatting
  - static/css/log-formatter.css - Styling voor geformatteerde logs
- **Bestanden gewijzigd**:
  - templates/home.html - Integratie van log formatter

### Bugfix: AttributeError in send_prompt_stream (Issue #42)
- **Probleem**: Thread context had geen toegang tot current_user.id, wat resulteerde in AttributeError
- **Oplossing**: 
  - User ID wordt nu vastgelegd voordat de thread start
  - Flask app context wordt doorgegeven aan de worker functie
  - Worker functie accepteert nu app en user_id als parameters
- **Impact**: Streaming endpoints werken nu correct met database persistence in thread context
- **Bestanden gewijzigd**: routes/api.py

### Implementatie van Conversation Persistence (Issue #39)
- **Database Integratie**: Volledig geïntegreerde ConversationManager met database backend
- **API Uitbreiding**: Nieuwe endpoints voor conversation management:
  - GET /api/conversations (met pagination)
  - GET /api/conversations/search (search functionaliteit)
  - POST /api/conversations (create met metadata)
  - PUT/PATCH /api/conversations/<id> (update titel/status)
  - DELETE /api/conversations/<id> (soft/hard delete)
  - DELETE /api/conversations/bulk (bulk delete operaties)
- **Persistence Features**:
  - Lazy loading met pagination voor grote conversation lijsten
  - Conversation search op titel en content
  - Conversation metadata (titel, laatste update, model)
  - Soft delete functionaliteit voor data behoud
  - Bulk operations voor conversation management
- **Error Handling**: Robuuste foutafhandeling en logging
- **Testing**: Uitgebreide unit tests voor nieuwe functionaliteit
- **Backwards Compatibility**: Behoud van bestaande in-memory functionaliteit

### Implementatie van gesplitste chat/log kolommen (Issue #36)
- **UI Verbetering**: Chat en log berichten worden nu in aparte kolommen weergegeven (70/30 verdeling)
- **JavaScript aanpassingen**: Nieuwe `addLogMessage()` functie voor het toevoegen van logs aan de juiste kolom
- **CSS uitbreiding**: Nieuwe styles voor de gesplitste kolom layout met responsive design
- **Functionaliteit behoud**: Chat away werkt alleen met chat berichten, logs worden niet doorgestuurd

### Implementatie van project_info.txt caching (Issue #35)
- **Configuratie uitbreiding**: Toevoeging van lazy loading voor project_info.txt in AnthropicConfig
- **Cache ondersteuning**: AnthropicClient ondersteunt nu ephemeral caching van project_info naast system prompt
- **Conditionele inclusie**: AnthropicAPI bepaalt automatisch wanneer project_info moet worden meegestuurd op basis van de prompt inhoud
- **Performance verbetering**: Verminderde API latency voor ontwikkel-gerelateerde vragen door project informatie te cachen
- **Testing**: Uitgebreide unit tests voor nieuwe caching functionaliteit

### Refactoring van config.py en anthropic_api.py (Issue #30)
- **Configuratie Management**: Implementatie van lazy loading voor configuratiebestanden, centralisatie van Anthropic configuratie in aparte module
- **Code Duplicatie**: Verwijdering van dubbele configuratie logic, consolidatie van API key validatie
- **Architectuur Verbetering**: Splitsing van AnthropicAPI in kleinere, gefocuste componenten met duidelijke verantwoordelijkheden
- **Backwards Compatibility**: Behoud van bestaande interfaces voor minimale impact op bestaande code
- **Testing**: Toevoeging van unit tests voor nieuwe modules